#! /usr/bin/env ruby
require 'yaml'
require 'term/ansicolor'

include Term::ANSIColor


if ARGV[0]
  bookmark = ARGV[0].to_i - 1
  bookmarks = YAML.load(File.open('.bookmarks'))
  `mate #{bookmarks[bookmark][:path]} -l #{bookmarks[bookmark][:line_number]}`
else
  i = 0
  bookmarks = []
  ARGF.each do |line|
    error = line.match(/(.*)\((.*)\).*\[(.*):(\d*)\]/)


    error = line.match(/(.*):(\d*):.*<.*>/)

    if error
      test_case, test, path, line_number = *error[1..4]
      bookmarks[i] = {test_case: test_case, test: test, path: path, line_number: line_number}
      i += 1
      puts "#{red(test_case)}(#{test}) [#{bold(path)}:#{line_number}]"
    else
      puts line
    end

  end

  # Write the bookmarks to disk.
  File.open('.bookmarks', "w") {|file| file.puts(bookmarks.to_yaml) }
end

